#!/bin/bash
# Signed by Mr_Pink ‚Äî Nosso Papo (nossopapo.net)
# Script de instala√ß√£o completa para Ubuntu 24.04 LTS
# Vers√£o: 1.0.0

set -e

# Cores ANSI
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
ORANGE='\033[0;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Vari√°veis
DOMAIN="nossopapo.net"
APP_DIR="/var/www/nossopapo"
REPO_URL="https://github.com/mrpink2025/papo-leve-chat.git"
LOG_DIR="${APP_DIR}/logs"
INSTALL_LOG="${LOG_DIR}/install_$(date +%Y%m%d_%H%M%S).log"
NODE_VERSION="20"

# Criar estrutura de diret√≥rios (antes de qualquer log)
mkdir -p "$APP_DIR"
mkdir -p "$LOG_DIR"
mkdir -p "${APP_DIR}/backups"

# Fun√ß√£o para logging
log() {
    mkdir -p "$(dirname "$INSTALL_LOG")" 2>/dev/null || true
    echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $1" | tee -a "$INSTALL_LOG"
}

error() {
    mkdir -p "$(dirname "$INSTALL_LOG")" 2>/dev/null || true
    echo -e "${RED}[ERROR]${NC} $1" | tee -a "$INSTALL_LOG"
    exit 1
}

warning() {
    mkdir -p "$(dirname "$INSTALL_LOG")" 2>/dev/null || true
    echo -e "${YELLOW}[WARNING]${NC} $1" | tee -a "$INSTALL_LOG"
}

success() {
    mkdir -p "$(dirname "$INSTALL_LOG")" 2>/dev/null || true
    echo -e "${GREEN}‚úÖ $1${NC}" | tee -a "$INSTALL_LOG"
}

# Banner de in√≠cio
clear
echo -e "${ORANGE}${BOLD}"
cat << "EOF"
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     _   _                         _____                     
    | \ | | ___  ___  ___  ___    |  __ \  __ _ _ __   ___  
    |  \| |/ _ \/ __/ __|/ _ \   | |__) |/ _` | '_ \ / _ \ 
    | |\  | (_) \__ \__ \ (_) |  |  ___/| (_| | |_) | (_) |
    |_| \_|\___/|___/___/\___/   |_|     \__,_| .__/ \___/ 
                                              |_|           
          üí¨  NOSSO PAPO ‚Äî onde cada conversa importa
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
EOF
echo -e "${NC}"
echo -e "${CYAN}üöÄ Instala√ß√£o automatizada ‚Äî Ubuntu 24.04 LTS${NC}"
echo -e "${CYAN}üß† Assinado por: Mr_Pink${NC}"
echo -e "${CYAN}üåê Dom√≠nio: ${DOMAIN}${NC}"
echo -e "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n"

# Verifica√ß√£o de root
if [[ $EUID -ne 0 ]]; then
   error "Este script deve ser executado como root (use sudo)"
fi

# Valida√ß√£o do sistema
log "‚öôÔ∏è  Validando sistema operacional..."
if ! grep -q "Ubuntu 24.04" /etc/os-release; then
    warning "Sistema operacional n√£o √© Ubuntu 24.04 LTS. Continuando mesmo assim..."
fi
success "Sistema validado"

# Verificar estrutura de diret√≥rios
log "üìÅ Verificando estrutura de diret√≥rios..."
success "Diret√≥rios criados"

# Atualizar sistema
log "üîÑ Atualizando sistema..."
apt-get update -qq
apt-get upgrade -y -qq
success "Sistema atualizado"

# Instalar depend√™ncias b√°sicas
log "üì¶ Instalando depend√™ncias b√°sicas..."
apt-get install -y -qq \
    curl \
    git \
    build-essential \
    software-properties-common \
    apt-transport-https \
    ca-certificates \
    gnupg \
    lsb-release \
    ufw \
    fail2ban \
    unattended-upgrades \
    nginx \
    certbot \
    python3-certbot-nginx \
    jq \
    htop \
    figlet \
    lolcat 2>&1 | tee -a "$INSTALL_LOG" > /dev/null
success "Depend√™ncias instaladas"

# Instalar Node.js
log "üì¶ Instalando Node.js ${NODE_VERSION}..."
if ! command -v node &> /dev/null; then
    curl -fsSL https://deb.nodesource.com/setup_${NODE_VERSION}.x | bash - >> "$INSTALL_LOG" 2>&1
    apt-get install -y nodejs >> "$INSTALL_LOG" 2>&1
fi
success "Node.js $(node --version) instalado"

# Instalar Bun (build tool)
log "üì¶ Instalando Bun..."
if ! command -v bun &> /dev/null; then
    curl -fsSL https://bun.sh/install | bash >> "$INSTALL_LOG" 2>&1
    export BUN_INSTALL="$HOME/.bun"
    export PATH="$BUN_INSTALL/bin:$PATH"
fi
success "Bun instalado"

# Clonar reposit√≥rio
log "üì• Clonando reposit√≥rio oficial..."
if [ -d "${APP_DIR}/src" ]; then
    log "Reposit√≥rio j√° existe, fazendo pull..."
    cd "$APP_DIR" || error "N√£o foi poss√≠vel acessar $APP_DIR"
    if ! git pull >> "$INSTALL_LOG" 2>&1; then
        error "Falha ao atualizar reposit√≥rio. Verifique conex√£o com GitHub."
    fi
else
    # Limpar diret√≥rio se existir mas estiver incompleto (preservando logs/backups)
    if [ -d "$APP_DIR" ] && [ "$(ls -A "$APP_DIR" 2>/dev/null)" ]; then
        warning "Diret√≥rio existe mas pode estar incompleto. Limpando (preservando logs/backups)..."
        # Remover tudo, exceto logs e backups
        find "$APP_DIR" -mindepth 1 -maxdepth 1 ! -name 'logs' ! -name 'backups' -exec rm -rf {} +
        # Garantir que os diret√≥rios cr√≠ticos existam
        mkdir -p "$LOG_DIR" "${APP_DIR}/backups"
    fi
    
    log "Clonando de $REPO_URL para diret√≥rio tempor√°rio..."
    TMP_DIR="$(mktemp -d -p /tmp nossopapo_clone_XXXXXX)"
    if ! git clone "$REPO_URL" "$TMP_DIR" >> "$INSTALL_LOG" 2>&1; then
        rm -rf "$TMP_DIR"
        error "Falha ao clonar reposit√≥rio de $REPO_URL. Verifique: 1) Conex√£o com internet 2) Acesso ao GitHub 3) URL do reposit√≥rio"
    fi
    
    # Mover o conte√∫do do clone para APP_DIR (preservando logs/backups)
    shopt -s dotglob
    if ! mv "$TMP_DIR"/* "$APP_DIR"/ >> "$INSTALL_LOG" 2>&1; then
        shopt -u dotglob
        rm -rf "$TMP_DIR"
        error "Falha ao mover arquivos clonados para $APP_DIR"
    fi
    shopt -u dotglob
    rm -rf "$TMP_DIR"
fi

cd "$APP_DIR" || error "N√£o foi poss√≠vel acessar $APP_DIR"

# Verificar se o clone foi bem-sucedido
if [ ! -f "package.json" ]; then
    error "Reposit√≥rio clonado mas package.json n√£o encontrado. Clone pode estar incompleto."
fi

success "Reposit√≥rio clonado e verificado"

# Instalar depend√™ncias do projeto
log "üì¶ Instalando depend√™ncias do projeto..."
if ! bun install >> "$INSTALL_LOG" 2>&1; then
    error "Falha ao instalar depend√™ncias do projeto. Verifique $INSTALL_LOG para detalhes."
fi
success "Depend√™ncias do projeto instaladas"

# Configurar .env
log "‚öôÔ∏è  Configurando vari√°veis de ambiente..."
if [ ! -f "${APP_DIR}/.env" ]; then
    cat > "${APP_DIR}/.env" << 'ENVEOF'
# Signed by Mr_Pink ‚Äî Nosso Papo (nossopapo.net)
VITE_SUPABASE_URL=https://valazbmgqazykdzcwfcs.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZhbGF6Ym1ncWF6eWtkemN3ZmNzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1ODI1OTIsImV4cCI6MjA3NjE1ODU5Mn0.BKwXC0ZnGz1F0W7uMoJQcaUvN5K6mNJk5fYdj1LukFI
NODE_ENV=production
ENVEOF
    success "Arquivo .env criado"
else
    log ".env j√° existe, mantendo configura√ß√£o existente"
fi

# Build do projeto
log "üî® Building projeto..."
if ! bun run build >> "$INSTALL_LOG" 2>&1; then
    error "Falha no build do projeto. Verifique $INSTALL_LOG para detalhes."
fi

# Verificar se o build gerou os arquivos
if [ ! -d "${APP_DIR}/dist" ] || [ ! -f "${APP_DIR}/dist/index.html" ]; then
    error "Build conclu√≠do mas diret√≥rio dist n√£o foi gerado corretamente."
fi

success "Build conclu√≠do e verificado"

# Configurar Nginx
log "üåê Configurando Nginx (HTTP inicial)..."
cat > /etc/nginx/sites-available/nossopapo << 'NGINXCONF'
# Signed by Mr_Pink ‚Äî Nosso Papo (nossopapo.net)
# Configura√ß√£o inicial HTTP (SSL ser√° adicionado pelo Certbot)

server {
    listen 80;
    listen [::]:80;
    server_name nossopapo.net www.nossopapo.net;
    
    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # Remove server tokens
    server_tokens off;
    
    # Root directory
    root /var/www/nossopapo/dist;
    index index.html;

    # Compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;

    # Cache static assets
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # PWA service worker
    location /sw.js {
        add_header Cache-Control "no-cache";
        proxy_cache_bypass $http_pragma;
        proxy_cache_revalidate on;
        expires off;
        access_log off;
    }

    # Manifest
    location /manifest.json {
        add_header Cache-Control "max-age=3600";
    }

    # Main application
    location / {
        try_files $uri $uri/ /index.html;
        add_header Cache-Control "no-cache";
    }

    # Security
    location ~ /\.(?!well-known) {
        deny all;
    }

    # Logs
    access_log /var/log/nginx/nossopapo_access.log;
    error_log /var/log/nginx/nossopapo_error.log;
}
NGINXCONF

# Ativar site
ln -sf /etc/nginx/sites-available/nossopapo /etc/nginx/sites-enabled/
rm -f /etc/nginx/sites-enabled/default

# Testar configura√ß√£o ANTES de recarregar
log "üß™ Testando configura√ß√£o do Nginx..."
if ! nginx -t >> "$INSTALL_LOG" 2>&1; then
    error "‚ùå Configura√ß√£o do Nginx inv√°lida! Execute: nginx -t"
fi
log "‚úì Checkpoint: Configura√ß√£o Nginx v√°lida"

# Recarregar apenas se teste passou
log "üîÑ Recarregando Nginx..."
if ! systemctl reload nginx >> "$INSTALL_LOG" 2>&1; then
    error "‚ùå Falha ao recarregar Nginx! Execute: systemctl status nginx"
fi
success "Nginx configurado e rodando (HTTP)"
log "‚úì Checkpoint: Nginx rodando na porta 80"

# Configurar SSL com Certbot
log "üîê Configurando certificado SSL..."

# Verificar se j√° existe certificado
if [ -d "/etc/letsencrypt/live/${DOMAIN}" ]; then
    log "‚úÖ Certificado SSL j√° existe"
    SSL_STATUS="existing"
else
    log "üìú Solicitando certificado SSL via Certbot (timeout: 5min)..."
    
    # Executar com timeout de 5 minutos
    if timeout 300 certbot --nginx \
        -d "$DOMAIN" -d "www.${DOMAIN}" \
        --non-interactive \
        --agree-tos \
        --email "admin@${DOMAIN}" \
        --redirect \
        --quiet >> "$INSTALL_LOG" 2>&1; then
        
        success "Certificado SSL instalado e HTTPS ativado"
        SSL_STATUS="installed"
        
        # Testar configura√ß√£o SSL
        if ! nginx -t >> "$INSTALL_LOG" 2>&1; then
            warning "‚ö†Ô∏è  Configura√ß√£o SSL criada mas inv√°lida. Verifique: nginx -t"
            SSL_STATUS="invalid"
        fi
        
    else
        EXIT_CODE=$?
        if [ $EXIT_CODE -eq 124 ]; then
            warning "‚è±Ô∏è  Certbot timeout ap√≥s 5min. Configure manualmente: sudo certbot --nginx -d $DOMAIN"
        else
            warning "‚ùå Certbot falhou (c√≥digo $EXIT_CODE). Verifique: 1) DNS apontando corretamente 2) Portas 80/443 abertas"
            warning "Configure manualmente: sudo certbot --nginx -d $DOMAIN"
        fi
        log "‚ö†Ô∏è  Continuando instala√ß√£o sem SSL (site acess√≠vel via HTTP)"
        SSL_STATUS="failed"
    fi
fi

log "‚úì Checkpoint: Configura√ß√£o SSL processada (status: $SSL_STATUS)"

# Configurar renova√ß√£o autom√°tica SSL
if [ "$SSL_STATUS" = "installed" ] || [ "$SSL_STATUS" = "existing" ]; then
    log "üîê Configurando renova√ß√£o autom√°tica SSL..."
    systemctl enable certbot.timer >> "$INSTALL_LOG" 2>&1
    systemctl start certbot.timer >> "$INSTALL_LOG" 2>&1
    success "Renova√ß√£o autom√°tica SSL configurada"
fi

# Configurar Firewall (UFW)
log "üõ°Ô∏è  Configurando firewall..."
ufw --force enable >> "$INSTALL_LOG" 2>&1
ufw default deny incoming >> "$INSTALL_LOG" 2>&1
ufw default allow outgoing >> "$INSTALL_LOG" 2>&1
ufw allow ssh >> "$INSTALL_LOG" 2>&1
ufw allow 'Nginx Full' >> "$INSTALL_LOG" 2>&1
ufw delete allow 'Nginx HTTP' >> "$INSTALL_LOG" 2>&1 || true
success "Firewall configurado"

# Configurar Fail2Ban
log "üõ°Ô∏è  Configurando Fail2Ban..."
cat > /etc/fail2ban/jail.local << 'FAIL2BAN'
[DEFAULT]
bantime = 3600
findtime = 600
maxretry = 5

[sshd]
enabled = true
port = ssh
logpath = /var/log/auth.log

[nginx-http-auth]
enabled = true
port = http,https
logpath = /var/log/nginx/error.log

[nginx-limit-req]
enabled = true
port = http,https
logpath = /var/log/nginx/error.log
FAIL2BAN

systemctl enable fail2ban
systemctl restart fail2ban
success "Fail2Ban configurado"

# Configurar atualiza√ß√µes autom√°ticas
log "üîÑ Configurando atualiza√ß√µes autom√°ticas..."
cat > /etc/apt/apt.conf.d/50unattended-upgrades << 'AUTOUPDATE'
Unattended-Upgrade::Allowed-Origins {
    "${distro_id}:${distro_codename}";
    "${distro_id}:${distro_codename}-security";
    "${distro_id}ESMApps:${distro_codename}-apps-security";
    "${distro_id}ESM:${distro_codename}-infra-security";
};
Unattended-Upgrade::AutoFixInterruptedDpkg "true";
Unattended-Upgrade::MinimalSteps "true";
Unattended-Upgrade::Remove-Unused-Kernel-Packages "true";
Unattended-Upgrade::Remove-Unused-Dependencies "true";
Unattended-Upgrade::Automatic-Reboot "false";
AUTOUPDATE

systemctl enable unattended-upgrades
systemctl start unattended-upgrades
success "Atualiza√ß√µes autom√°ticas configuradas"

# Configurar logrotate
log "üìù Configurando logrotate..."
cat > /etc/logrotate.d/nossopapo << 'LOGROTATE'
/var/www/nossopapo/logs/*.log {
    daily
    missingok
    rotate 14
    compress
    delaycompress
    notifempty
    create 0640 www-data www-data
    sharedscripts
}
LOGROTATE
success "Logrotate configurado"

# Configurar MOTD personalizado
log "üé® Configurando MOTD personalizado..."

# Limpar mensagens padr√£o do Ubuntu
chmod -x /etc/update-motd.d/* 2>/dev/null || true

# Criar script MOTD personalizado
cat > /etc/update-motd.d/10-nossopapo << 'MOTD'
#!/bin/bash
# Signed by Mr_Pink ‚Äî Nosso Papo (nossopapo.net)

# Cores
ORANGE='\033[0;33m'
CYAN='\033[0;36m'
GREEN='\033[0;32m'
BOLD='\033[1m'
NC='\033[0m'

# Informa√ß√µes do sistema
UPTIME=$(uptime -p | sed 's/up //')
MEMORY=$(free -h | awk '/^Mem:/ {print $3 "/" $2}')
DISK=$(df -h / | awk 'NR==2 {print $3 "/" $2 " (" $5 ")"}')
LOAD=$(uptime | awk -F'load average:' '{print $2}')

echo -e "${ORANGE}${BOLD}"
cat << "EOF"
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     _   _                         _____                     
    | \ | | ___  ___  ___  ___    |  __ \  __ _ _ __   ___  
    |  \| |/ _ \/ __/ __|/ _ \   | |__) |/ _` | '_ \ / _ \ 
    | |\  | (_) \__ \__ \ (_) |  |  ___/| (_| | |_) | (_) |
    |_| \_|\___/|___/___/\___/   |_|     \__,_| .__/ \___/ 
                                              |_|           
          üí¨  NOSSO PAPO ‚Äî onde cada conversa importa
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
EOF
echo -e "${NC}"

echo -e "${CYAN}üåê Dom√≠nio:${NC}       https://nossopapo.net"
echo -e "${CYAN}üì¶ Caminho:${NC}       /var/www/nossopapo"
echo -e "${CYAN}üîê SSL:${NC}           /etc/letsencrypt/live/nossopapo.net"
echo -e "${CYAN}‚öôÔ∏è  Ambiente:${NC}     Produ√ß√£o ‚Äî Ubuntu 24.04 LTS"
echo -e "${CYAN}üß† Autor:${NC}         Mr_Pink"
echo -e "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
echo -e "${GREEN}üìä Status do Sistema:${NC}"
echo -e "  Uptime:   ${UPTIME}"
echo -e "  Mem√≥ria:  ${MEMORY}"
echo -e "  Disco:    ${DISK}"
echo -e "  Load:    ${LOAD}"
echo -e "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
echo -e "${CYAN}${BOLD}\"Conex√µes reais. Conversas que ficam.\"${NC}"
echo -e "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
echo ""
MOTD

chmod +x /etc/update-motd.d/10-nossopapo

# Desabilitar mensagens de last login (opcional)
touch ~/.hushlogin

success "MOTD personalizado configurado"

# Configurar permiss√µes
log "üîê Configurando permiss√µes..."
chown -R www-data:www-data "$APP_DIR"
chmod -R 755 "$APP_DIR"
success "Permiss√µes configuradas"

# Criar script de backup
log "üíæ Criando script de backup..."
cat > "${APP_DIR}/backup.sh" << 'BACKUP'
#!/bin/bash
# Signed by Mr_Pink ‚Äî Nosso Papo (nossopapo.net)
# Script de backup autom√°tico

BACKUP_DIR="/var/www/nossopapo/backups"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="${BACKUP_DIR}/nossopapo_backup_${DATE}.tar.gz"

# Criar backup
tar -czf "$BACKUP_FILE" \
    --exclude='/var/www/nossopapo/node_modules' \
    --exclude='/var/www/nossopapo/backups' \
    --exclude='/var/www/nossopapo/logs' \
    /var/www/nossopapo/

# Manter apenas √∫ltimos 7 backups
find "$BACKUP_DIR" -name "nossopapo_backup_*.tar.gz" -mtime +7 -delete

echo "Backup criado: $BACKUP_FILE"
BACKUP

chmod +x "${APP_DIR}/backup.sh"

# Adicionar cron para backup di√°rio
(crontab -l 2>/dev/null; echo "0 2 * * * ${APP_DIR}/backup.sh >> ${LOG_DIR}/backup.log 2>&1") | crontab -

success "Script de backup configurado"

# Verifica√ß√£o de sa√∫de
log "üè• Executando verifica√ß√£o de sa√∫de..."

# Verificar Nginx
if systemctl is-active --quiet nginx; then
    success "Nginx est√° rodando"
else
    error "Nginx n√£o est√° rodando"
fi

# Verificar SSL
if [ -f "/etc/letsencrypt/live/${DOMAIN}/fullchain.pem" ]; then
    CERT_EXPIRY=$(openssl x509 -enddate -noout -in "/etc/letsencrypt/live/${DOMAIN}/fullchain.pem" | cut -d= -f2)
    success "SSL v√°lido at√©: ${CERT_EXPIRY}"
else
    warning "Certificado SSL n√£o encontrado"
fi

# Verificar firewall
if ufw status | grep -q "Status: active"; then
    success "Firewall ativo"
else
    warning "Firewall n√£o est√° ativo"
fi

# Verificar Fail2Ban
if systemctl is-active --quiet fail2ban; then
    success "Fail2Ban est√° rodando"
else
    warning "Fail2Ban n√£o est√° rodando"
fi

# Criar script de verifica√ß√£o PWA
log "üì± Criando script de verifica√ß√£o PWA..."
cat > "${APP_DIR}/check_pwa.sh" << 'PWA'
#!/bin/bash
# Signed by Mr_Pink ‚Äî Nosso Papo (nossopapo.net)
# Verifica√ß√£o PWA

DOMAIN="nossopapo.net"

echo "üîç Verificando PWA para ${DOMAIN}..."
echo ""

# Verificar manifest
if curl -s "https://${DOMAIN}/manifest.json" | jq . > /dev/null 2>&1; then
    echo "‚úÖ manifest.json v√°lido"
else
    echo "‚ùå manifest.json inv√°lido ou n√£o encontrado"
fi

# Verificar service worker
if curl -s -I "https://${DOMAIN}/sw.js" | grep -q "200 OK"; then
    echo "‚úÖ Service worker encontrado"
else
    echo "‚ùå Service worker n√£o encontrado"
fi

# Verificar HTTPS
if curl -s -I "https://${DOMAIN}" | grep -q "200 OK"; then
    echo "‚úÖ HTTPS funcionando"
else
    echo "‚ùå HTTPS n√£o funcionando"
fi

# Verificar √≠cones PWA
for size in 192 512; do
    if curl -s -I "https://${DOMAIN}/app-icon-${size}.png" | grep -q "200 OK"; then
        echo "‚úÖ √çcone ${size}x${size} encontrado"
    else
        echo "‚ùå √çcone ${size}x${size} n√£o encontrado"
    fi
done

echo ""
echo "üîó Teste manual: https://web.dev/measure/?url=https://${DOMAIN}"
PWA

chmod +x "${APP_DIR}/check_pwa.sh"
success "Script de verifica√ß√£o PWA criado"

# Verificar sa√∫de do sistema antes de finalizar
log "üè• Verificando sa√∫de do sistema..."

# Verificar Nginx
if systemctl is-active --quiet nginx; then
    if nginx -t &>/dev/null; then
        success "Nginx: rodando com configura√ß√£o v√°lida"
        NGINX_STATUS="ok"
    else
        warning "Nginx: rodando mas configura√ß√£o tem erros (execute: nginx -t)"
        NGINX_STATUS="config_error"
    fi
else
    warning "Nginx: n√£o est√° rodando! (execute: systemctl status nginx)"
    NGINX_STATUS="stopped"
fi

# Verificar SSL e definir protocolo
if [ -d "/etc/letsencrypt/live/${DOMAIN}" ]; then
    if [ -f "/etc/letsencrypt/live/${DOMAIN}/fullchain.pem" ]; then
        success "SSL: certificado instalado e v√°lido"
        PROTOCOL="https"
        SSL_INFO="‚úÖ Certificado v√°lido em /etc/letsencrypt/live/${DOMAIN}"
    else
        warning "SSL: diret√≥rio existe mas certificado incompleto"
        PROTOCOL="http"
        SSL_INFO="‚ö†Ô∏è  SSL parcialmente configurado - use HTTP por enquanto"
    fi
else
    warning "SSL: n√£o configurado (site acess√≠vel apenas via HTTP)"
    PROTOCOL="http"
    SSL_INFO="‚ö†Ô∏è  Certbot n√£o executou - configure manualmente: sudo certbot --nginx -d ${DOMAIN}"
fi

# Verificar build
if [ -f "${APP_DIR}/dist/index.html" ]; then
    success "Build: dist/ presente e v√°lido"
    BUILD_STATUS="ok"
else
    warning "Build: dist/index.html n√£o encontrado"
    BUILD_STATUS="missing"
fi

log "‚úì Checkpoint: Verifica√ß√µes de sa√∫de conclu√≠das"

# Finalizar instala√ß√£o
log "üìù Gerando relat√≥rio de instala√ß√£o..."

# Salvar informa√ß√µes no log
cat >> "$INSTALL_LOG" << REPORT

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
üìä RELAT√ìRIO DE INSTALA√á√ÉO
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Data/Hora: $(date +'%Y-%m-%d %H:%M:%S')
Sistema: $(lsb_release -d | cut -f2)
Node.js: $(node --version)
Nginx: $(nginx -v 2>&1 | cut -d'/' -f2)
Dom√≠nio: ${DOMAIN}
Diret√≥rio: ${APP_DIR}
Protocolo: ${PROTOCOL}

Status dos Componentes:
‚Ä¢ Nginx: ${NGINX_STATUS}
‚Ä¢ SSL: ${SSL_STATUS:-not_checked}
‚Ä¢ Build: ${BUILD_STATUS}

Servi√ßos Ativos:
$(systemctl is-active nginx) - Nginx
$(systemctl is-active fail2ban) - Fail2Ban
$(systemctl is-active certbot.timer 2>/dev/null || echo "inactive") - Certbot Timer
$(systemctl is-active unattended-upgrades) - Auto Updates

Signed by Mr_Pink ‚Äî Nosso Papo (nossopapo.net)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
REPORT

# Banner final
clear
echo -e "${GREEN}${BOLD}"
cat << "EOF"
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  ‚úÖ  INSTALA√á√ÉO FINALIZADA COM SUCESSO!
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
EOF
echo -e "${NC}"

echo -e "${CYAN}üåê Acesse:${NC}        ${PROTOCOL}://${DOMAIN}"
echo -e "${CYAN}             ${NC}        ${PROTOCOL}://www.${DOMAIN}"
echo -e "${CYAN}üìÇ Diret√≥rio:${NC}     ${APP_DIR}"
echo -e "${CYAN}üîê SSL:${NC}           ${SSL_INFO}"
echo -e "${CYAN}üìù Logs:${NC}          ${LOG_DIR}"
echo -e "${CYAN}üß† Assinado por:${NC}  Mr_Pink"
echo ""
echo -e "${GREEN}‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ${NC}"
echo -e "${GREEN}${BOLD}üöÄ Nosso Papo est√° ativo e pronto para uso!${NC}"
echo -e "${GREEN}‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ${NC}"
echo ""
echo -e "${CYAN}üìã Comandos √∫teis:${NC}"
echo -e "  ‚Ä¢ Ver logs:           tail -f ${LOG_DIR}/install_*.log"
echo -e "  ‚Ä¢ Verificar PWA:      ${APP_DIR}/check_pwa.sh"
echo -e "  ‚Ä¢ Backup manual:      ${APP_DIR}/backup.sh"
echo -e "  ‚Ä¢ Status Nginx:       systemctl status nginx"
echo -e "  ‚Ä¢ Testar Nginx:       nginx -t"
if [ "$PROTOCOL" = "https" ]; then
    echo -e "  ‚Ä¢ Renovar SSL:        certbot renew --dry-run"
else
    echo -e "  ‚Ä¢ Configurar SSL:     sudo certbot --nginx -d ${DOMAIN}"
fi
echo ""
echo -e "${YELLOW}üí° Pr√≥ximos passos:${NC}"
echo -e "  1. Fa√ßa logout e login novamente para ver o novo MOTD"
echo -e "  2. Teste o acesso: ${PROTOCOL}://${DOMAIN}"
echo -e "  3. Execute: ${APP_DIR}/check_pwa.sh"
echo -e "  4. Configure as vari√°veis de ambiente em ${APP_DIR}/.env"
if [ "$PROTOCOL" = "http" ]; then
    echo -e "  ${YELLOW}5. Configure SSL manualmente: sudo certbot --nginx -d ${DOMAIN}${NC}"
fi
echo ""
echo -e "${GREEN}‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ${NC}"
echo -e "${CYAN}\"Conex√µes reais. Conversas que ficam.\"${NC}"
echo -e "${GREEN}‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ${NC}"
echo ""

log "‚úÖ Instala√ß√£o conclu√≠da com sucesso!"
log "üìù Log completo salvo em: $INSTALL_LOG"
