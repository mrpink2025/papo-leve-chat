# üîî Guia de Integra√ß√£o - Sistema de Notifica√ß√µes Nosso Papo

## üìö Como Integrar Notifica√ß√µes no Fluxo de Mensagens

### 1. Integra√ß√£o B√°sica no Hook de Mensagens

Edite `src/hooks/useMessages.tsx` para adicionar notifica√ß√µes:

```typescript
import { useNotificationManager } from './useNotificationManager';
import { useConversationNotifications } from './useConversationNotifications';
import { hasMention } from '@/utils/mentionDetection';

export const useMessages = (conversationId: string) => {
  const { user } = useAuth();
  const { notifyNewMessage } = useNotificationManager();
  const { shouldNotify } = useConversationNotifications(conversationId);
  
  // ... c√≥digo existente ...

  // Listener para novas mensagens em tempo real
  useEffect(() => {
    const channel = supabase
      .channel(`messages:${conversationId}`)
      .on(
        'postgres_changes',
        {
          event: 'INSERT',
          schema: 'public',
          table: 'messages',
          filter: `conversation_id=eq.${conversationId}`,
        },
        async (payload) => {
          const newMessage = payload.new;
          
          // N√£o notificar se √© a pr√≥pria mensagem
          if (newMessage.sender_id === user?.id) return;
          
          // N√£o notificar se a conversa est√° aberta e vis√≠vel
          if (document.visibilityState === 'visible' && 
              window.location.pathname.includes(conversationId)) {
            return;
          }

          // Buscar dados do remetente
          const { data: sender } = await supabase
            .from('profiles')
            .select('username, full_name, avatar_url')
            .eq('id', newMessage.sender_id)
            .single();

          if (!sender) return;

          // Detectar men√ß√£o
          const isMention = hasMention(newMessage.content, user?.username || '');

          // Verificar prefer√™ncias da conversa
          if (!shouldNotify(isMention)) return;

          // Enviar notifica√ß√£o
          await notifyNewMessage(
            conversationId,
            newMessage.sender_id,
            sender.full_name || sender.username,
            newMessage.content,
            newMessage.id,
            sender.avatar_url,
            isMention
          );
        }
      )
      .subscribe();

    return () => {
      supabase.removeChannel(channel);
    };
  }, [conversationId, user, notifyNewMessage, shouldNotify]);

  // ... resto do c√≥digo ...
};
```

---

### 2. Integra√ß√£o com Rea√ß√µes

Edite `src/hooks/useReactions.tsx`:

```typescript
import { useNotificationManager } from './useNotificationManager';

export const useReactions = () => {
  const { user } = useAuth();
  const { notifyReaction } = useNotificationManager();
  
  const addReaction = useMutation({
    mutationFn: async ({ messageId, emoji }) => {
      // ... c√≥digo de inser√ß√£o ...
      
      // Buscar dados da mensagem para notificar o autor
      const { data: message } = await supabase
        .from('messages')
        .select('sender_id, content, conversation_id')
        .eq('id', messageId)
        .single();

      if (!message || message.sender_id === user?.id) return;

      // Buscar nome do reator
      const { data: reactor } = await supabase
        .from('profiles')
        .select('full_name, username')
        .eq('id', user?.id)
        .single();

      if (!reactor) return;

      // Notificar autor da mensagem
      await notifyReaction(
        message.conversation_id,
        reactor.full_name || reactor.username,
        emoji,
        message.content.substring(0, 50), // Preview curto
        messageId
      );
    },
  });

  return { addReaction };
};
```

---

### 3. Integra√ß√£o com Chamadas

Edite `src/hooks/useVideoCall.tsx`:

```typescript
import { useNotificationManager } from './useNotificationManager';

export const useVideoCall = () => {
  const { notifyCall } = useNotificationManager();
  
  const startCall = async (conversationId: string, isVideoCall: boolean = true) => {
    // ... c√≥digo existente ...

    // Buscar participantes da conversa
    const { data: participants } = await supabase
      .from('conversation_participants')
      .select('user_id, profiles(username, full_name, avatar_url)')
      .eq('conversation_id', conversationId)
      .neq('user_id', user?.id);

    // Buscar dados do caller
    const { data: caller } = await supabase
      .from('profiles')
      .select('full_name, username, avatar_url')
      .eq('id', user?.id)
      .single();

    if (!caller) return;

    // Notificar cada participante
    for (const participant of participants || []) {
      await notifyCall(
        conversationId,
        caller.full_name || caller.username,
        isVideoCall,
        caller.avatar_url
      );
    }
  };

  return { startCall };
};
```

---

### 4. Notifica√ß√µes de Sistema

Exemplos de uso para eventos do sistema:

```typescript
import { useNotificationManager } from '@/hooks/useNotificationManager';

// Quando algu√©m √© adicionado ao grupo
const notifyUserAddedToGroup = async (
  conversationId: string,
  addedUserId: string,
  groupName: string
) => {
  const { notifySystem } = useNotificationManager();
  
  await notifySystem(
    conversationId,
    'üë• Adicionado ao grupo',
    `Voc√™ foi adicionado ao grupo "${groupName}"`
  );
};

// Quando algu√©m √© promovido a admin
const notifyUserPromoted = async (
  conversationId: string,
  userId: string,
  groupName: string
) => {
  const { notifySystem } = useNotificationManager();
  
  await notifySystem(
    conversationId,
    '‚≠ê Promovido a Admin',
    `Voc√™ agora √© administrador do grupo "${groupName}"`
  );
};

// Quando h√° atualiza√ß√£o do app
const notifyAppUpdate = async () => {
  const { notifySystem } = useNotificationManager();
  
  // Notificar em alguma conversa padr√£o ou criar sistema de notifica√ß√µes globais
  await notifySystem(
    'system', // Pode criar uma conversa especial "Sistema"
    'üîÑ Atualiza√ß√£o dispon√≠vel',
    'Uma nova vers√£o do Nosso Papo est√° dispon√≠vel. Recarregue para atualizar.'
  );
};
```

---

### 5. Verifica√ß√£o Antes de Enviar

**SEMPRE use esta ordem de verifica√ß√µes:**

```typescript
// 1. Verificar se n√£o √© o pr√≥prio usu√°rio
if (senderId === currentUser.id) return;

// 2. Verificar se a conversa est√° aberta
if (isConversationOpen(conversationId)) return;

// 3. Detectar categoria e prioridade
const isMention = hasMention(content, currentUser.username);
const category = isMention ? 'mentions' : 'messages';

// 4. Verificar prefer√™ncias da conversa
const { shouldNotify } = useConversationNotifications(conversationId);
if (!shouldNotify(isMention)) return;

// 5. Enviar (passa por todas as verifica√ß√µes internas)
await notifyNewMessage(...);
```

---

## üéØ Checklist de Integra√ß√£o

### Backend (Edge Functions)
- [ ] VAPID keys configuradas
- [ ] Edge function `send-push-notification` com web-push library
- [ ] L√≥gica de retry com backoff
- [ ] Logging adequado

### Frontend (React)
- [ ] Hooks importados nos componentes corretos
- [ ] Listeners de realtime conectados
- [ ] Detec√ß√£o de men√ß√µes implementada
- [ ] Verifica√ß√£o de conversa aberta
- [ ] Deep links funcionando

### Service Worker
- [ ] Handlers de push configurados
- [ ] Prioriza√ß√£o aplicada (vibra√ß√£o, sons)
- [ ] Tag de agrupamento por conversa
- [ ] Click handlers com deep links
- [ ] Badge API integrada

### UI/UX
- [ ] P√°gina de configura√ß√µes de categorias
- [ ] Menu de notifica√ß√µes por conversa
- [ ] Feedback visual (toasts)
- [ ] Estados de loading
- [ ] Educacional para permiss√µes

---

## üß™ Cen√°rios de Teste

### Teste 1: Fluxo Completo
1. Ativar notifica√ß√µes globalmente
2. Entrar em uma conversa
3. Configurar para "Somente men√ß√µes"
4. Pedir para algu√©m enviar: "Oi, tudo bem?"
5. **Esperado**: Nenhuma notifica√ß√£o
6. Pedir para enviar: "@seuusername ol√°!"
7. **Esperado**: Notifica√ß√£o com prioridade ALTA

### Teste 2: Rate Limiting
1. Configurar categoria "messages" para agrupar
2. Enviar 50 mensagens rapidamente (script ou bot)
3. **Esperado**: 
   - Primeiras 30 notificadas individualmente
   - Depois: agrupamento "50 novas mensagens"

### Teste 3: Prioriza√ß√£o
1. Enviar mensagem normal ‚Üí Som padr√£o
2. Enviar men√ß√£o ‚Üí Som diferente (mais alto)
3. Iniciar chamada ‚Üí Som urgente + requireInteraction
4. Reagir ‚Üí Sem som (prioridade baixa)

### Teste 4: Quiet Hours + Categorias
1. Configurar Quiet Hours (22:00 - 08:00)
2. Desativar "Permitir urgentes" em Quiet Hours
3. √Äs 23:00, receber:
   - Mensagem normal ‚Üí Bloqueada
   - Men√ß√£o ‚Üí Bloqueada
   - Chamada ‚Üí Depende da config (pode passar se urgentes permitidos)

---

## üì± Comportamento por Plataforma

### Chrome/Edge (Desktop & Android)
- ‚úÖ Todas as categorias funcionam
- ‚úÖ Prioriza√ß√£o completa
- ‚úÖ Agrupamento por tag
- ‚úÖ A√ß√µes nas notifica√ß√µes
- ‚úÖ Badge API

### Firefox (Desktop & Android)
- ‚úÖ Todas as categorias funcionam
- ‚ö†Ô∏è Badge API limitado
- ‚úÖ Agrupamento por tag
- ‚ö†Ô∏è A√ß√µes limitadas

### Safari (macOS)
- ‚úÖ Notifica√ß√µes funcionam
- ‚ö†Ô∏è Sem a√ß√µes nas notifica√ß√µes
- ‚ö†Ô∏è Sem badge API
- ‚úÖ Som e vibra√ß√£o

### Safari (iOS)
- ‚ö†Ô∏è Apenas PWA instalado (iOS 16.4+)
- ‚úÖ Notifica√ß√µes b√°sicas
- ‚ùå Sem a√ß√µes avan√ßadas
- ‚ùå Sem badge API

---

## üö® Problemas Comuns

### "Notifica√ß√µes n√£o aparecem"
1. Verificar permiss√£o: `Notification.permission === 'granted'`
2. Verificar Service Worker ativo
3. Verificar VAPID keys configuradas
4. Ver console para logs de bloqueio

### "Notifica√ß√µes n√£o agrupam"
1. Verificar se `group_similar` est√° ativo na categoria
2. Verificar se `tag` est√° sendo usado corretamente
3. Navegador precisa suportar (Chrome/Edge melhor)

### "Rate limiting muito restritivo"
1. Ajustar limites em `useNotificationRateLimit.tsx`
2. Aumentar RATE_LIMITS por categoria
3. Considerar aumentar WINDOW_DURATION

### "Som n√£o toca"
1. Verificar prefer√™ncias globais (som ativado?)
2. Verificar categoria (som ativado?)
3. Navegador pode bloquear som se usu√°rio n√£o interagiu
4. Verificar `silent: false` no payload

---

## üìä M√©tricas Importantes

Para acompanhar a sa√∫de do sistema:

```typescript
// Taxa de entrega
const deliveryRate = notificationsSent / notificationsAttempted;

// Taxa de cliques
const clickRate = notificationsClicked / notificationsSent;

// Taxa de agrupamento
const groupingRate = notificationsGrouped / notificationsSent;

// Taxa de bloqueio por rate limit
const rateLimitRate = notificationsBlocked / notificationsAttempted;
```

Adicionar tracking destes eventos na tabela `analytics_events` para monitoramento.

---

## üîÑ Manuten√ß√£o

### Cleanup Autom√°tico
Configure um cron job para limpar dados antigos:

```sql
-- Executar a cada hora
SELECT cron.schedule(
  'cleanup-notifications',
  '0 * * * *', -- A cada hora
  $$
  SELECT cleanup_expired_notifications();
  $$
);
```

### Monitoramento
Queries √∫teis para monitorar:

```sql
-- Ver rate limits ativos
SELECT user_id, conversation_id, category, count, window_start
FROM notification_rate_limit
WHERE window_start > now() - interval '1 hour'
ORDER BY count DESC;

-- Ver notifica√ß√µes agrupadas recentemente
SELECT conversation_id, category, title, grouped_count, sent_at
FROM notification_history
WHERE sent_at > now() - interval '1 hour'
AND grouped_count > 1
ORDER BY grouped_count DESC;

-- Ver categorias mais bloqueadas
SELECT category, COUNT(*) as blocked_count
FROM notification_rate_limit
WHERE count >= 30
GROUP BY category
ORDER BY blocked_count DESC;
```

---

## ‚úÖ Status das Fases

- ‚úÖ **Fase 1**: Infraestrutura Push - Service Worker, VAPID, tokens, deep links
- ‚úÖ **Fase 2**: Prefer√™ncias Globais - Som, vibra√ß√£o, badges, quiet hours
- ‚úÖ **Fase 3**: Prefer√™ncias por Conversa - Modos, sil√™ncio tempor√°rio
- ‚úÖ **Fase 4**: Categorias e Prioriza√ß√£o - 5 categorias, rate limiting, agrupamento

**Pr√≥ximo: Fase 5** - Sincroniza√ß√£o Multi-device

---

## üéä Conclus√£o da Fase 4

O sistema de notifica√ß√µes agora √© **completo e robusto**:

‚ú® **5 categorias** configur√°veis individualmente  
‚ú® **4 n√≠veis de prioridade** com comportamentos distintos  
‚ú® **Rate limiting** inteligente por categoria  
‚ú® **Agrupamento autom√°tico** para reduzir spam  
‚ú® **Anti-spam** com limites por minuto  
‚ú® **Prefer√™ncias em 3 camadas** (global, conversa, categoria)  

**Pronto para produ√ß√£o!** üöÄ
