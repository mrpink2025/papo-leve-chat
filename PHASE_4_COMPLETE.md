# ‚úÖ Fase 4 Conclu√≠da: Categorias e Prioriza√ß√£o

## üéâ Implementado

A Fase 4 do sistema de notifica√ß√µes est√° completa! Sistema robusto de categorias, prioriza√ß√£o, rate limiting e agrupamento implementado.

---

## üì¶ O que foi criado

### 1. **Banco de Dados**

#### Enums
- `notification_category`: 'messages', 'mentions', 'calls', 'reactions', 'system'
- `notification_priority`: 'low', 'normal', 'high', 'urgent'

#### Tabelas
- **`notification_category_preferences`** - Prefer√™ncias por categoria
  - Ativar/desativar por categoria
  - Prioridade configur√°vel
  - Som individual por categoria
  - Flag de agrupamento

- **`notification_rate_limit`** - Rate limiting
  - Contador por usu√°rio + conversa + categoria
  - Janela de 1 minuto
  - Auto-limpeza de registros antigos

- **`notification_history`** - Hist√≥rico para agrupamento
  - Registro de notifica√ß√µes enviadas
  - Contador de agrupamento
  - Expira em 12 horas
  - Usado para consolidar notifica√ß√µes similares

#### Fun√ß√£o
- `cleanup_expired_notifications()` - Limpa hist√≥rico e rate limits antigos

### 2. **Hooks React**

#### `useNotificationCategories`
Gerencia prefer√™ncias de categorias:
```typescript
const {
  categoryPreferences,        // Array com todas as prefer√™ncias
  getCategorySettings,        // Obter config de uma categoria
  isCategoryEnabled,          // Verificar se categoria est√° ativa
  getCategoryPriority,        // Obter prioridade da categoria
  updateCategory,             // Atualizar prefer√™ncias
} = useNotificationCategories();
```

#### `useNotificationRateLimit`
Controla rate limiting:
```typescript
const {
  checkRateLimit,      // Verificar se pode enviar
  incrementRateLimit,  // Incrementar contador
  resetRateLimit,      // Resetar (√∫til para testes)
  rateLimits,          // Limites por categoria
} = useNotificationRateLimit();
```

**Limites por categoria:**
- Mensagens: 30/minuto
- Men√ß√µes: 10/minuto
- Chamadas: 5/minuto
- Rea√ß√µes: 20/minuto
- Sistema: 10/minuto

#### `useNotificationGrouping`
Gerencia agrupamento:
```typescript
const {
  shouldGroupNotification,    // Verificar e agrupar se necess√°rio
  cleanupOldNotifications,    // Limpar notifica√ß√µes expiradas
} = useNotificationGrouping();
```

#### `useNotificationManager` üåü (CENTRAL)
**Hook principal** que integra tudo:
```typescript
const {
  shouldSendNotification,  // Decis√£o completa (todas as verifica√ß√µes)
  sendNotification,        // Enviar notifica√ß√£o gen√©rica
  notifyNewMessage,        // Helper para mensagens
  notifyReaction,          // Helper para rea√ß√µes
  notifyCall,              // Helper para chamadas
  notifySystem,            // Helper para sistema
} = useNotificationManager();
```

### 3. **Componente UI**

#### `NotificationCategorySettings`
Card completo para configurar categorias:
- ‚úÖ Lista todas as 5 categorias
- ‚úÖ Toggle para ativar/desativar cada uma
- ‚úÖ Badge visual de prioridade (Urgente/Alta/Normal/Baixa)
- ‚úÖ Controles de som por categoria
- ‚úÖ Controles de agrupamento por categoria
- ‚úÖ √çcones intuitivos para cada categoria
- ‚úÖ Info box explicando prioriza√ß√£o

---

## üéØ Sistema de Categorias

### **5 Categorias Implementadas**

| Categoria | √çcone | Prioridade | Som Padr√£o | Agrupa | Descri√ß√£o |
|-----------|-------|------------|------------|---------|-----------|
| **Men√ß√µes** | @ | üî¥ Urgente‚ÜíAlta | ‚úÖ | ‚ùå | @voc√™ ou @todos |
| **Chamadas** | üìû | üî¥ Urgente | ‚úÖ | ‚ùå | Voz e v√≠deo |
| **Mensagens** | üí¨ | üîµ Normal | ‚úÖ | ‚úÖ | Mensagens normais |
| **Rea√ß√µes** | ‚ù§Ô∏è | ‚ö™ Baixa | ‚ùå | ‚úÖ | Rea√ß√µes √†s mensagens |
| **Sistema** | ‚ÑπÔ∏è | ‚ö™ Baixa | ‚ùå | ‚úÖ | Admin, grupo, avisos |

---

## üéöÔ∏è Sistema de Prioriza√ß√£o

### **N√≠veis de Prioridade**

1. **üî¥ Urgente** (Chamadas)
   - Som alto e distintivo
   - Vibra√ß√£o forte (padr√£o: [400, 200, 400])
   - N√£o agrupa nunca
   - `requireInteraction: true` (notifica√ß√£o fica at√© ser clicada)
   - Sobrescreve Quiet Hours (opcional por configura√ß√£o)

2. **üü† Alta** (Men√ß√µes)
   - Som not√°vel
   - Vibra√ß√£o m√©dia (padr√£o: [200, 100, 200])
   - Nunca agrupa
   - Sempre vis√≠vel, mesmo em tela bloqueada
   - Bypass parcial de rate limiting (+50% do limite)

3. **üîµ Normal** (Mensagens)
   - Som padr√£o
   - Vibra√ß√£o normal (padr√£o: [200, 100, 200])
   - Agrupa por conversa (se configurado)
   - Rate limiting padr√£o

4. **‚ö™ Baixa** (Rea√ß√µes, Sistema)
   - Sem som por padr√£o
   - Sem vibra√ß√£o
   - Sempre agrupa
   - Rate limiting rigoroso
   - Pode ser enviado como "resumo" em lote

---

## üõ°Ô∏è Rate Limiting e Anti-Spam

### **Limites por Categoria**
```typescript
const RATE_LIMITS = {
  messages: 30,    // 30 mensagens/minuto por conversa
  mentions: 10,    // 10 men√ß√µes/minuto
  calls: 5,        // 5 chamadas/minuto
  reactions: 20,   // 20 rea√ß√µes/minuto (agrupadas)
  system: 10,      // 10 notifica√ß√µes sistema/minuto
};
```

### **Janela de Tempo**
- 1 minuto por janela
- Contador √© incrementado a cada notifica√ß√£o
- Reset autom√°tico ap√≥s 1 minuto
- Limpeza de registros antigos (> 1 hora)

### **Comportamento ao Exceder**
1. Notifica√ß√µes excedentes s√£o **bloqueadas**
2. Se agrupamento estiver ativo, **consolida** em uma notifica√ß√£o
3. Exemplo: 50 mensagens em 1 min ‚Üí 1 notifica√ß√£o "50 novas mensagens"

---

## üì¶ Sistema de Agrupamento

### **Como Funciona**

1. **Janela de Agrupamento**: 30 segundos
2. **Crit√©rios**:
   - Mesma conversa
   - Mesma categoria
   - Dentro da janela de tempo
   - Categoria tem `group_similar: true`

3. **Processo**:
   ```typescript
   Mensagem 1: "Jo√£o: Oi"         ‚Üí Notifica√ß√£o 1: "Jo√£o: Oi"
   Mensagem 2: "Jo√£o: Tudo bem?"  ‚Üí Notifica√ß√£o 1: "Jo√£o: 2 novas mensagens"
   Mensagem 3: "Jo√£o: Cad√™ voc√™?" ‚Üí Notifica√ß√£o 1: "Jo√£o: 3 novas mensagens"
   [30s depois]
   Mensagem 4: "Jo√£o: ?"          ‚Üí Notifica√ß√£o 2: "Jo√£o: ?"
   ```

### **Tag de Agrupamento**
```typescript
tag: `conv-${conversationId}` 
// Todas as notifica√ß√µes da mesma conversa compartilham a mesma tag
// Navegador automaticamente substitui notifica√ß√£o antiga pela nova
```

### **Categorias que Agrupam**
- ‚úÖ Mensagens (se configurado)
- ‚úÖ Rea√ß√µes (sempre)
- ‚úÖ Sistema (sempre)
- ‚ùå Men√ß√µes (nunca agrupa)
- ‚ùå Chamadas (nunca agrupa)

---

## üîÑ Fluxo Completo de Decis√£o

```
Nova Mensagem
    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. Verificar Globais (Fase 2)  ‚îÇ
‚îÇ    - Notifica√ß√µes habilitadas?  ‚îÇ
‚îÇ    - Quiet Hours ativo?          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            ‚Üì SIM
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 2. Verificar Conversa (Fase 3) ‚îÇ
‚îÇ    - Conversa silenciada?        ‚îÇ
‚îÇ    - Modo: all/mentions/muted?   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            ‚Üì SIM
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 3. Verificar Categoria (Fase 4)‚îÇ
‚îÇ    - Categoria habilitada?       ‚îÇ
‚îÇ    - Prioridade?                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            ‚Üì SIM
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 4. Rate Limiting                ‚îÇ
‚îÇ    - Dentro do limite?           ‚îÇ
‚îÇ    - Incrementar contador        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            ‚Üì SIM
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 5. Agrupamento                  ‚îÇ
‚îÇ    - Notifica√ß√£o recente?        ‚îÇ
‚îÇ    - Categoria agrupa?           ‚îÇ
‚îÇ    - Consolidar se sim           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            ‚Üì
    ‚úÖ ENVIAR NOTIFICA√á√ÉO
```

---

## üíª Como Integrar no App

### Exemplo: Notificar Nova Mensagem
```typescript
import { useNotificationManager } from '@/hooks/useNotificationManager';
import { useConversationNotifications } from '@/hooks/useConversationNotifications';

// No componente de mensagens
const { notifyNewMessage } = useNotificationManager();
const { shouldNotify } = useConversationNotifications(conversationId);

// Quando nova mensagem chegar
const handleNewMessage = async (message) => {
  // Detectar se √© men√ß√£o
  const isMention = message.content.includes(`@${currentUser.username}`) ||
                   message.content.includes('@todos');

  // Verificar prefer√™ncias da conversa
  if (!shouldNotify(isMention)) {
    console.log('Notifica√ß√£o bloqueada por prefer√™ncias da conversa');
    return;
  }

  // Enviar notifica√ß√£o (passa por todas as verifica√ß√µes)
  await notifyNewMessage(
    conversationId,
    message.sender_id,
    senderName,
    message.content,
    message.id,
    senderAvatar,
    isMention
  );
};
```

### Exemplo: Notificar Rea√ß√£o
```typescript
const { notifyReaction } = useNotificationManager();

// Quando algu√©m reagir √† sua mensagem
await notifyReaction(
  conversationId,
  reactorName,
  '‚ù§Ô∏è',
  'Sua mensagem aqui...',
  messageId
);
```

### Exemplo: Notificar Chamada
```typescript
const { notifyCall } = useNotificationManager();

// Quando receber chamada
await notifyCall(
  conversationId,
  callerName,
  true, // isVideo
  callerAvatar
);
```

---

## üé® Interface de Categorias

### Localiza√ß√£o
`/app/configuracoes/notificacoes` ‚Üí Se√ß√£o "Categorias de notifica√ß√µes"

### Elementos Visuais
- **Card por categoria** com:
  - √çcone colorido
  - Nome e descri√ß√£o
  - Badge de prioridade (com cores)
  - Toggle principal (ativar/desativar)
  - Controles secund√°rios:
    - Som individual
    - Agrupar similares (quando aplic√°vel)

### Feedback
- ‚úÖ Auto-save em todas as altera√ß√µes
- ‚úÖ Toast com confirma√ß√£o
- ‚úÖ Estados de loading
- ‚úÖ Info box explicativa sobre prioriza√ß√£o

---

## üîç Exemplos Pr√°ticos

### Cen√°rio 1: Grupo Muito Ativo
**Problema**: 100 mensagens em 5 minutos
**Solu√ß√£o**:
1. Rate limit: bloqueia ap√≥s 30/min
2. Agrupamento: consolida em "30 novas mensagens"
3. Resultado: 1 notifica√ß√£o ao inv√©s de 100

### Cen√°rio 2: Men√ß√£o Importante
**Problema**: Precisa chamar aten√ß√£o mesmo em grupo silenciado
**Solu√ß√£o**:
1. Categoria "mentions" tem prioridade ALTA
2. N√£o agrupa nunca
3. Som distintivo
4. Sobrescreve configura√ß√£o "silenciado" da conversa (se men√ß√µes ativadas globalmente)

### Cen√°rio 3: M√∫ltiplas Rea√ß√µes
**Problema**: 10 pessoas reagiram √† sua mensagem
**Solu√ß√£o**:
1. Categoria "reactions" tem prioridade BAIXA
2. Agrupa automaticamente
3. Sem som por padr√£o
4. Resultado: "10 pessoas reagiram √† sua mensagem"

### Cen√°rio 4: Chamada Urgente
**Problema**: Precisa notificar imediatamente
**Solu√ß√£o**:
1. Categoria "calls" tem prioridade URGENTE
2. Nunca agrupa
3. requireInteraction: true (fica na tela)
4. Som + vibra√ß√£o fortes
5. Sobrescreve Quiet Hours (opcional)

---

## üìä Estrutura de Dados

### CategoryPreference
```typescript
interface CategoryPreference {
  category: NotificationCategory;
  enabled: boolean;
  priority: NotificationPriority;
  sound_enabled: boolean;
  group_similar: boolean;
}
```

### Valores Padr√£o por Categoria
```typescript
{
  messages: {
    enabled: true,
    priority: 'normal',
    sound_enabled: true,
    group_similar: true,
  },
  mentions: {
    enabled: true,
    priority: 'high',
    sound_enabled: true,
    group_similar: false, // ‚Üê Importante!
  },
  calls: {
    enabled: true,
    priority: 'urgent',
    sound_enabled: true,
    group_similar: false, // ‚Üê Importante!
  },
  reactions: {
    enabled: true,
    priority: 'low',
    sound_enabled: false, // ‚Üê Sem som por padr√£o
    group_similar: true,
  },
  system: {
    enabled: true,
    priority: 'low',
    sound_enabled: false,
    group_similar: true,
  },
}
```

---

## üöÄ Performance e Otimiza√ß√£o

### √çndices Criados
- `user_id` em todas as tabelas
- `conversation_id` + `window_start` em rate_limit
- `user_id` + `conversation_id` + `sent_at` em history
- `expires_at` em history

### Queries Otimizadas
- Usa `maybeSingle()` para evitar erros quando n√£o h√° dados
- Upsert com `onConflict` para evitar duplicatas
- Batch inserts para criar prefer√™ncias padr√£o
- Limita queries a 1 resultado quando apropriado

### Cleanup Autom√°tico
- Fun√ß√£o `cleanup_expired_notifications()` pode ser agendada
- Remove hist√≥rico > 12 horas
- Remove rate limits > 1 hora
- Mant√©m tabelas leves e perform√°ticas

---

## üîê Seguran√ßa

### RLS Policies
- ‚úÖ Usu√°rios s√≥ veem suas pr√≥prias prefer√™ncias
- ‚úÖ Usu√°rios s√≥ veem seu pr√≥prio hist√≥rico
- ‚úÖ Usu√°rios s√≥ veem seus pr√≥prios rate limits
- ‚úÖ Rate limits incrementados apenas por backend

### Valida√ß√£o
- ‚úÖ Enums garantem valores v√°lidos
- ‚úÖ Unique constraints evitam duplicatas
- ‚úÖ Foreign keys garantem integridade
- ‚úÖ Timestamps autom√°ticos

---

## üß™ Testes Sugeridos

### 1. Teste de Rate Limiting
```typescript
// Enviar 50 mensagens rapidamente
for (let i = 0; i < 50; i++) {
  await notifyNewMessage(conversationId, senderId, 'Teste', `Mensagem ${i}`, messageId);
}
// Resultado esperado: Apenas ~30 notifica√ß√µes (ou 1 agrupada)
```

### 2. Teste de Agrupamento
```typescript
// Enviar 5 mensagens em 10 segundos
for (let i = 0; i < 5; i++) {
  await notifyNewMessage(conversationId, senderId, 'Jo√£o', `Oi ${i}`, messageId);
  await sleep(2000);
}
// Resultado esperado: 1 notifica√ß√£o "Jo√£o: 5 novas mensagens"
```

### 3. Teste de Prioriza√ß√£o
```typescript
// Enviar uma mensagem normal
await notifyNewMessage(conversationId, senderId, 'Maria', 'Oi', messageId, '', false);

// Enviar uma men√ß√£o
await notifyNewMessage(conversationId, senderId, 'Maria', '@voc√™ urgente!', messageId, '', true);

// Resultado esperado: Men√ß√£o aparece primeiro/com som diferente
```

### 4. Teste de Categorias Desativadas
```typescript
// Desativar categoria "reactions"
await updateCategory({
  category: 'reactions',
  updates: { enabled: false }
});

// Enviar rea√ß√£o
await notifyReaction(conversationId, 'Pedro', '‚ù§Ô∏è', 'Sua msg', messageId);

// Resultado esperado: Nenhuma notifica√ß√£o enviada
```

---

## üéØ Pr√≥ximas Fases

### Fase 5: Sincroniza√ß√£o Multi-device (2h)
- Gerenciar m√∫ltiplos dispositivos
- Deduplica√ß√£o entre devices
- Badges sincronizados
- Estados lido/entregue

### Fase 6: Notifica√ß√µes de Chamadas (1-2h)
- Ringtone customizado
- Cart√£o de chamada interativo
- Chamadas perdidas com callback

### Fase 7: Otimiza√ß√µes Finais (1h)
- Telemetria e analytics
- Performance final
- QA completo

---

## ‚ú® Destaques da Fase 4

1. **Sistema Robusto**: 5 categorias, 4 prioridades, totalmente configur√°vel
2. **Anti-Spam Inteligente**: Rate limiting por categoria + agrupamento autom√°tico
3. **Prioriza√ß√£o Clara**: Men√ß√µes e chamadas sempre t√™m preced√™ncia
4. **Performance**: √çndices otimizados, queries eficientes
5. **UX Polida**: Interface intuitiva com badges visuais de prioridade
6. **Seguran√ßa**: RLS completo, valida√ß√£o em todos os n√≠veis
7. **Flexibilidade**: Cada categoria pode ser configurada independentemente

---

## üéä Conclus√£o

**Sistema de notifica√ß√µes agora tem:**
- ‚úÖ Fase 1: Infraestrutura Push (SW, VAPID, tokens, deep links)
- ‚úÖ Fase 2: Prefer√™ncias Globais (som, vibra√ß√£o, badges, quiet hours)
- ‚úÖ Fase 3: Prefer√™ncias por Conversa (modos, sil√™ncio tempor√°rio)
- ‚úÖ Fase 4: Categorias e Prioriza√ß√£o (5 categorias, rate limiting, agrupamento)

**Pr√≥ximo: Fase 5 (Sincroniza√ß√£o Multi-device)** üöÄ

---

## üìö Documenta√ß√£o Adicional

- [Web Push Protocol](https://datatracker.ietf.org/doc/html/rfc8030)
- [Notification Best Practices](https://web.dev/push-notifications-overview/)
- [Service Worker Notification Events](https://developer.mozilla.org/en-US/docs/Web/API/ServiceWorkerRegistration/showNotification)
